name: 'Slopless Security Scan'
description: 'AI-powered security scanner for vibe-coded apps. Find vulnerabilities before they find you.'
author: 'XORS Software'

branding:
  icon: 'shield'
  color: 'purple'

inputs:
  license-key:
    description: 'Your Slopless license key. Get one at https://slopless.work'
    required: true
  mode:
    description: 'Mode: auto (default), scan, or review-pr. Auto uses review-pr for PRs, scan for pushes.'
    required: false
    default: 'auto'
  path:
    description: 'Path to scan (default: current directory, only used in scan mode)'
    required: false
    default: '.'
  github-token:
    description: 'GitHub token for PR review (defaults to GITHUB_TOKEN)'
    required: false
    default: ${{ github.token }}
  fail-on-critical:
    description: 'Fail the workflow if critical vulnerabilities are found'
    required: false
    default: 'true'
  fail-on-high:
    description: 'Fail the workflow if high severity vulnerabilities are found'
    required: false
    default: 'false'
  auto-fix:
    description: 'Generate fix suggestions for vulnerabilities'
    required: false
    default: 'true'
  cross-validate:
    description: 'Cross-validate HIGH/CRITICAL findings to reduce false positives'
    required: false
    default: 'true'
  output-format:
    description: 'Output format: rich, json, or markdown'
    required: false
    default: 'markdown'
  output-file:
    description: 'Save report to this file path'
    required: false
    default: 'slopless-report.json'
  python-version:
    description: 'Python version to use'
    required: false
    default: '3.12'
  comment-on-pr:
    description: 'Post scan results as a PR comment (requires pull_request trigger)'
    required: false
    default: 'true'

outputs:
  total-vulnerabilities:
    description: 'Total number of vulnerabilities/findings found'
    value: ${{ steps.analyze.outputs.total }}
  critical-count:
    description: 'Number of critical vulnerabilities'
    value: ${{ steps.analyze.outputs.critical }}
  high-count:
    description: 'Number of high severity vulnerabilities'
    value: ${{ steps.analyze.outputs.high }}
  medium-count:
    description: 'Number of medium severity vulnerabilities'
    value: ${{ steps.analyze.outputs.medium }}
  low-count:
    description: 'Number of low severity vulnerabilities'
    value: ${{ steps.analyze.outputs.low }}
  report-path:
    description: 'Path to the generated report file'
    value: ${{ steps.analyze.outputs.report_path }}
  scan-passed:
    description: 'Whether the scan passed the configured thresholds'
    value: ${{ steps.check.outputs.passed }}
  verdict:
    description: 'PR review verdict (approve/request_changes/comment) - only for review-pr mode'
    value: ${{ steps.analyze.outputs.verdict }}
  mode-used:
    description: 'The mode that was used (scan or review-pr)'
    value: ${{ steps.analyze.outputs.mode }}

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install Slopless CLI
      shell: bash
      run: |
        pip install --upgrade pip
        pip install slopless
        slopless --version

    - name: Run Security Analysis
      id: analyze
      shell: bash
      env:
        SLOPLESS_LICENSE_KEY: ${{ inputs.license-key }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        set +e  # Don't exit on error, we handle it ourselves
        
        # Determine mode
        MODE="${{ inputs.mode }}"
        if [ "$MODE" = "auto" ]; then
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            MODE="review-pr"
          else
            MODE="scan"
          fi
        fi
        
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        
        if [ "$MODE" = "review-pr" ]; then
          # PR Review mode - analyze just the PR diff
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          
          echo "ğŸ” Reviewing PR: $PR_URL"
          
          REVIEW_CMD="slopless review-pr '$PR_URL'"
          REVIEW_CMD="$REVIEW_CMD --format json"
          REVIEW_CMD="$REVIEW_CMD --output ${{ inputs.output-file }}"
          REVIEW_CMD="$REVIEW_CMD --github-token '$GITHUB_TOKEN'"
          
          echo "Running: slopless review-pr $PR_URL --format json"
          eval $REVIEW_CMD
          ANALYSIS_EXIT_CODE=$?
          
          # Parse PR review results
          if [ -f "${{ inputs.output-file }}" ]; then
            TOTAL=$(jq '.total_findings // 0' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            CRITICAL=$(jq '.by_severity.critical // 0' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            HIGH=$(jq '.by_severity.high // 0' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            MEDIUM=$(jq '.by_severity.medium // 0' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            LOW=$(jq '.by_severity.low // 0' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            VERDICT=$(jq -r '.verdict // "comment"' "${{ inputs.output-file }}" 2>/dev/null || echo "comment")
            CONTEXT_USED=$(jq -r '.architecture_context_used // false' "${{ inputs.output-file }}" 2>/dev/null || echo "false")
          else
            TOTAL=0
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
            VERDICT="comment"
            CONTEXT_USED="false"
          fi
          
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
          
          # Write summary for PR review
          echo "## ğŸ” Slopless PR Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VERDICT_EMOJI="ğŸ’¬"
          if [ "$VERDICT" = "approve" ]; then
            VERDICT_EMOJI="âœ…"
          elif [ "$VERDICT" = "request_changes" ]; then
            VERDICT_EMOJI="âŒ"
          fi
          
          echo "**Verdict:** $VERDICT_EMOJI ${VERDICT^^}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$CONTEXT_USED" = "true" ]; then
            echo "ğŸ“š *Using architecture context from previous scan*" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
        else
          # Full scan mode
          SCAN_CMD="slopless scan ${{ inputs.path }}"
          SCAN_CMD="$SCAN_CMD --format json"
          SCAN_CMD="$SCAN_CMD --output ${{ inputs.output-file }}"
          
          if [ "${{ inputs.auto-fix }}" = "true" ]; then
            SCAN_CMD="$SCAN_CMD --auto-fix"
          else
            SCAN_CMD="$SCAN_CMD --no-fix"
          fi
          
          if [ "${{ inputs.cross-validate }}" = "true" ]; then
            SCAN_CMD="$SCAN_CMD --cross-validate"
          else
            SCAN_CMD="$SCAN_CMD --no-validate"
          fi
          
          echo "Running: $SCAN_CMD"
          eval $SCAN_CMD
          ANALYSIS_EXIT_CODE=$?
          
          # Parse scan results
          if [ -f "${{ inputs.output-file }}" ]; then
            TOTAL=$(jq '.vulnerabilities | length' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.vulnerabilities[] | select(.severity == "critical")] | length' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            HIGH=$(jq '[.vulnerabilities[] | select(.severity == "high")] | length' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.vulnerabilities[] | select(.severity == "medium")] | length' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
            LOW=$(jq '[.vulnerabilities[] | select(.severity == "low")] | length' "${{ inputs.output-file }}" 2>/dev/null || echo "0")
          else
            TOTAL=0
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
          fi
          
          echo "verdict=" >> $GITHUB_OUTPUT
          
          echo "## ğŸ›¡ï¸ Slopless Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Common outputs
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
        echo "low=$LOW" >> $GITHUB_OUTPUT
        echo "report_path=${{ inputs.output-file }}" >> $GITHUB_OUTPUT
        echo "exit_code=$ANALYSIS_EXIT_CODE" >> $GITHUB_OUTPUT
        
        # Summary table
        echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TOTAL" -eq 0 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **No issues found!**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check Thresholds
      id: check
      shell: bash
      run: |
        PASSED="true"
        CRITICAL=${{ steps.analyze.outputs.critical }}
        HIGH=${{ steps.analyze.outputs.high }}
        
        if [ "${{ inputs.fail-on-critical }}" = "true" ] && [ "$CRITICAL" -gt 0 ]; then
          echo "::error::Found $CRITICAL critical vulnerabilities"
          PASSED="false"
        fi
        
        if [ "${{ inputs.fail-on-high }}" = "true" ] && [ "$HIGH" -gt 0 ]; then
          echo "::error::Found $HIGH high severity vulnerabilities"
          PASSED="false"
        fi
        
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        
        if [ "$PASSED" = "false" ]; then
          exit 1
        fi

    - name: Generate Markdown Report
      if: inputs.output-format == 'markdown' || inputs.comment-on-pr == 'true'
      shell: bash
      env:
        SLOPLESS_LICENSE_KEY: ${{ inputs.license-key }}
      run: |
        if [ -f "${{ inputs.output-file }}" ]; then
          slopless scan ${{ inputs.path }} --format markdown --no-fix --no-validate > slopless-report.md 2>/dev/null || true
        fi

    - name: Comment on PR
      if: github.event_name == 'pull_request' && inputs.comment-on-pr == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          const total = '${{ steps.analyze.outputs.total }}';
          const critical = '${{ steps.analyze.outputs.critical }}';
          const high = '${{ steps.analyze.outputs.high }}';
          const medium = '${{ steps.analyze.outputs.medium }}';
          const low = '${{ steps.analyze.outputs.low }}';
          const verdict = '${{ steps.analyze.outputs.verdict }}';
          const mode = '${{ steps.analyze.outputs.mode }}';
          
          let body = '';
          
          // Different header based on mode
          if (mode === 'review-pr') {
            body = '## ğŸ” Slopless PR Review\n\n';
            
            // Show verdict for PR reviews
            const verdictEmoji = verdict === 'approve' ? 'âœ…' : (verdict === 'request_changes' ? 'âŒ' : 'ğŸ’¬');
            body += `**Verdict:** ${verdictEmoji} ${verdict.toUpperCase()}\n\n`;
          } else {
            body = '## ğŸ›¡ï¸ Slopless Security Scan\n\n';
          }
          
          body += '| Severity | Count |\n';
          body += '|----------|-------|\n';
          body += `| ğŸ”´ Critical | ${critical} |\n`;
          body += `| ğŸŸ  High | ${high} |\n`;
          body += `| ğŸŸ¡ Medium | ${medium} |\n`;
          body += `| ğŸŸ¢ Low | ${low} |\n`;
          body += `| **Total** | **${total}** |\n\n`;
          
          if (parseInt(total) === 0) {
            body += 'âœ… **No issues found!**\n';
          } else {
            body += '<details>\n<summary>ğŸ“‹ View detailed report</summary>\n\n';
            
            try {
              if (fs.existsSync('slopless-report.md')) {
                const report = fs.readFileSync('slopless-report.md', 'utf8');
                body += report;
              } else if (fs.existsSync('${{ inputs.output-file }}')) {
                const jsonReport = JSON.parse(fs.readFileSync('${{ inputs.output-file }}', 'utf8'));
                body += '```json\n' + JSON.stringify(jsonReport, null, 2) + '\n```\n';
              }
            } catch (e) {
              body += '_Report details not available_\n';
            }
            
            body += '\n</details>\n';
          }
          
          const tagline = mode === 'review-pr' ? 'AI PR Reviewer' : 'AI Security Scanner';
          body += `\n---\n_Powered by [Slopless](https://slopless.work) - ${tagline}_`;
          
          // Find existing comment (match both scan and review headers)
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            (comment.body.includes('ğŸ›¡ï¸ Slopless Security Scan') || comment.body.includes('ğŸ” Slopless PR Review'))
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

    - name: Upload Report Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: slopless-security-report
        path: |
          ${{ inputs.output-file }}
          slopless-report.md
        if-no-files-found: ignore
